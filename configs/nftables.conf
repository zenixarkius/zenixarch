#!/usr/bin/nft -f

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        ct state invalid drop
        ct state established,related accept

        iif "lo" accept

        ip protocol icmp accept
        ip6 nexthdr icmpv6 accept

        udp sport 67 udp dport 68 accept
        udp sport 68 udp dport 67 accept

        limit rate 1/minute log prefix "[DROP IN] "
    }

    chain forward {
        type filter hook forward priority 0; policy drop;

        limit rate 1/minute log prefix "[DROP FWD] "
    }

    chain output {
        type filter hook output priority 0; policy drop;

        oifname != "wg0" meta mark != 0xca6c ip daddr != 127.0.0.0/8 reject
        oifname != "wg0" meta mark != 0xca6c ip6 daddr != ::1 reject

        ct state established,related accept

        oif "lo" accept

        ip protocol icmp accept
        ip6 nexthdr icmpv6 accept

        udp sport 67 udp dport 68 accept
        udp sport 68 udp dport 67 accept

        tcp dport { 80, 443 } accept
        udp dport { 53, 123, 443, 51820 } accept

        limit rate 1/minute log prefix "[DROP OUT] "
    }
}
