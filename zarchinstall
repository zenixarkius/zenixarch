#!/usr/bin/bash
# shellcheck disable=1091

set -euo pipefail
(( EUID == 0 ))

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

export PACKAGES=(
  sys-fs/btrfs-progs
  gui-apps/foot
  dev-vcs/git
  #grimblast-git
  gui-wm/hyprland
  gui-apps/hyprpaper
  #hyprpicker
  net-firewall/nftables
  net-wireless/iwd
  #mullvad-browser-bin
  app-editors/neovim
  app-admin/pass-otp
  #pipewire-jack
  #pipewire-pulse
  app-crypt/sbctl
  net-im/signal-desktop-bin
  #ttf-liberation
  media-fonts/symbols-nerd-font
  net-vpn/wireguard-tools
  #wl-clipboard
)

export SERVICES=(
  #btrfs-scrub@-.timer
  #fstrim.timer
  #iwd.service
  #nftables.service
  #nvclock.service
  #rgb.service
  #systemd-timesyncd.service
  #wireguard.service
)

installation() {
  nvme id-ns -H /dev/"${DISK}" | grep -q '1.*4096' && nvme format -l 1 --force /dev/"${DISK}"

  sgdisk -Z /dev/"${DISK}"
  sgdisk -g /dev/"${DISK}"
  sgdisk -I -n 1:0:+512M -t 1:ef00 -c 1:bootfs /dev/"${DISK}"
  sgdisk -I -n 2:0:0 -t 2:8304 -c 2:rootfs /dev/"${DISK}"

  [[ ${DISK} =~ [0-9]$ ]] && DISK=${DISK}p

  mkfs.fat -F 32 /dev/"${DISK}"1

  cryptsetup -q luksFormat -h sha512 -i 5000 -s 512 /dev/"${DISK}"2 <<< "${PASS}"
  cryptsetup open /dev/"${DISK}"2 root <<< "${PASS}"

  mkfs.btrfs -f /dev/mapper/root

  mount /dev/mapper/root /mnt
  btrfs su cr /mnt/@
  btrfs su cr /mnt/@home
  btrfs su cr /mnt/@var
  btrfs su se /mnt/@
  umount /mnt

  mount -o defaults,compress-force=zstd,noatime /dev/mapper/root /mnt
  mkdir -p /mnt/{boot,home,var}
  mount -o defaults,nodev,nosuid,noexec,umask=0077 /dev/"${DISK}"1 /mnt/boot
  mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,subvol=@home /dev/mapper/root /mnt/home
  mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,subvol=@var /dev/mapper/root /mnt/var
  mkdir -p /mnt/var/{log,lib/libvirt/images}
  chattr +C /mnt/var/{log,lib/libvirt/images}

  curl -s https://distfiles.gentoo.org/releases/amd64/autobuilds/$(
    curl -s https://distfiles.gentoo.org/releases/amd64/autobuilds/latest-stage3-amd64-nomultilib-openrc.txt | awk '/stage3/ {print $1}'
    ) | tar xJpvf - --xattrs-include='*.*' --numeric-owner -C /mnt

  ln -s /run/NetworkManager/resolv.conf /mnt/etc/resolv.conf
  genfstab -U /mnt >> /mnt/etc/fstab

  useradd -R /mnt -m user
  chpasswd -R /mnt <<< root:"${PASS}"$'\n'user:"${PASS}"

  cp -r "${DIR}" /mnt/home/user/.zenixarch
  chown 1000:1000 -R /mnt/home/user/.zenixarch

  arch-chroot /mnt env DIR=/home/user/.zenixarch bash -c 'set -euo pipefail; emerge-webrsync; configuration'
}

configuration() {
  find "${DIR}"/rootfs -type f | while read -r src; do
    args=(-Dm644) dest=${src#"${DIR}"/rootfs}
    [[ ${src} == *.bin ]] && args=(-Dm755)
    if [[ ${src} == *.link ]]; then
      [[ $(readlink "${dest%.link}") == $(<"${src}") ]] || ln -sfn "$(<"${src}")" "${dest%.link}"
    else
      cmp -s "${src}" "${dest}" || install "${args[@]}" "${src}" "${dest}"
    fi
    [[ ${src} == */home/user/* ]] && chown user:user "${dest%.link}"
  done

#  if pacman -Q cachyos-keyring cachyos-mirrorlist cachyos-v3-mirrorlist &>/dev/null; then
#    pacman -S --noconfirm --needed "${PACKAGES[@]}"
#  else
#    pacman-key -a <(curl 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x882dcfe48e2051d48e2562abf3b607488db35a47')
#    pacman-key --lsign-key F3B607488DB35A47
#    pacman -U --noconfirm https://mirror.cachyos.org/repo/x86_64/cachyos/{cachyos-keyring-20240331-1-any,cachyos-mirrorlist-22-1-any,cachyos-v3-mirrorlist-22-1-any,pacman-7.1.0.r7.gb9f7d4a-3-x86_64}.pkg.tar.zst
#    pacman -Syu --noconfirm --needed "${PACKAGES[@]}"
#  fi
#
#  systemctl enable "${SERVICES[@]}"
#  systemctl list-unit-files -t service --state=enabled --no-legend | awk '{print $1}' | while read -r svc; do
#    [[ ${SERVICES[*]} == *${svc}* ]] || [[ ${svc} == getty@* ]] || systemctl disable "${svc}"
#  done
#
#  if ! pacman -Q linux-zenixark &>/dev/null; then
#  ( cp -r "${DIR}"/kernel /tmp/linux-zenixark
#    cd /tmp/linux-zenixark
#    . PKGBUILD
#    makedepends+=(base-devel)
#    pacman -S --noconfirm --needed "${makedepends[@]}"
#    runuser user -c makepkg
#    pacman -U --noconfirm linux-zenixark*.pkg.tar.zst || :
#    pacman -Rcns --noconfirm "${makedepends[@]}" )
#  fi
#
#  if sbctl status | grep -q 'Setup.*Enabled'; then
#    sbctl create-keys
#    sbctl enroll-keys -t
#    sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI
#  fi
#
#  if ! [[ $(pacman -Q openrgb | awk '{print $2}') == 1.0rc1-2 ]]; then
#    pacman -Rcns --noconfirm openrgb || : # OpenRGB is completely broken for me after this version for some reason
#    pacman -U --noconfirm https://archive.archlinux.org/repos/2025/08/31/extra/os/x86_64/openrgb-1.0rc1-2-x86_64.pkg.tar.zst
#  fi
#
#  sed -i 's|^;.*cookie-file.*|cookie-file = /tmp/.pulse-cookie|' /etc/pulse/client.conf # Fixes Steam creating ~/.pulse-cookie
#  sed -i 's|which|command -v|' /usr/lib/password-store/extensions/otp.bash # Fixes pass-otp 'which not found'
}

if [[ $(uname -n) == livecd ]]; then
  : "${DISK}:?" "${PASS}:?"

  read -rp $'You probably shouldn\'t be running this if you aren\'t Zenixark.\nType IK to continue to disk wiping: ' IK
  [[ ${IK} == IK ]]

  trap '( umount -R /mnt; cryptsetup close root ) &>/dev/null' EXIT

  export -f configuration
  installation
else
  configuration
fi
