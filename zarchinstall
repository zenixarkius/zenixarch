#!/bin/bash
set -euo pipefail

(( EUID == 0 )) || exit 1

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

configuration() {
    source "$DIR"/misc/lists.conf

    find "$DIR"/dotfiles -type f | while read -r src; do
        [[ "$src" = *user.js ]] && { cmp -s "$src" /home/user/.librewolf/user/user.js || install -Dm644 "$src" /home/user/.librewolf/user/user.js; } && continue
        [[ $(readlink /home/user/"${src#"$DIR"/dotfiles/}") = "$src" ]] || ln -sf "$src" /home/user/"${src#"$DIR"/dotfiles/}"
    done

    for d in /home/user/.{cache,local}; do
        [[ $(readlink "$d") = /tmp ]] || ln -sfn /tmp "$d"
    done

    chown user:user -R /home/user

    find "$DIR"/system -type f | while read -r src; do
        args=(-Dm644) dest=/etc/"${src#"$DIR"/system/}"
        [[ "$src" = *adguardhome.yaml ]] && args=(-Dm600 -o nobody -g nobody) dest=/var/lib/private/adguardhome/AdGuardHome.yaml
        [[ "$src" = *overclock.bin ]] && args=(-Dm755)
        cmp -s "$src" "$dest" || install "${args[@]}" "$src" "$dest"
    done

    if ! pacman -Q cachyos-mirrorlist &>/dev/null; then
        pacman-key --recv-keys F3B607488DB35A47 --keyserver keyserver.ubuntu.com
        pacman-key --lsign-key F3B607488DB35A47
        pacman -U https://mirror.cachyos.org/repo/x86_64/cachyos/cachyos-keyring-20240331-1-any.pkg.tar.zst https://mirror.cachyos.org/repo/x86_64/cachyos/cachyos-mirrorlist-22-1-any.pkg.tar.zst https://mirror.cachyos.org/repo/x86_64/cachyos/cachyos-v3-mirrorlist-22-1-any.pkg.tar.zst https://mirror.cachyos.org/repo/x86_64/cachyos/pacman-7.0.0.r7.g1f38429-2-x86_64.pkg.tar.zst
    fi

    pacman -S --noconfirm --needed --asdep "${DEPS[@]}"
    pacman -S --noconfirm --needed "${PACKAGES[@]}"

    if ! [[ $(pacman -Q openrgb | awk '{print $2}') = 1.0rc1-2 ]]; then (
        cd /tmp # OpenRGB is completely broken for me after this version
        pacman -Rcns --noconfirm openrgb
        curl -OJ https://archive.archlinux.org/repos/2025/08/31/extra/os/x86_64/openrgb-1.0rc1-2-x86_64.pkg.tar.zst
        pacman -U --noconfirm openrgb*.zst
    ) fi

    sed -i 's|^;.*cookie-file.*|cookie-file = /tmp/.pulse-cookie|' /etc/pulse/client.conf # Fix Steam creating ~/.pulse-cookie
    sed -i 's|which|command -v|' /usr/lib/password-store/extensions/otp.bash # Fix pass-otp `which not found'

    systemctl enable "${UNITS[@]}"
    systemctl mask "${MASKED[@]}"

    for svc in $(systemctl list-unit-files --type=service --state=enabled --no-legend | awk '{print $1}'); do
        [[ "${UNITS[*]}" = *$svc* ]] || [[ "$svc" = getty@* ]] || systemctl disable "$svc"
    done

    sbctl status | grep -q 'Setup.*Enabled' && [[ -e /dev/tpm0 ]] && sbctl create-keys && sbctl enroll-keys --tpm-eventlog && sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI

    echo Done
    exit
}

[[ -d /run/archiso ]] || configuration
: "$DISK:?" "$PASS:?"

read -rp $'You probably shouldn\'t be running this if you aren\'t Zenixark.\nType IK to continue to disk wiping: ' IK
[[ "$IK" = IK ]] || exit 1

umount -R /mnt &> /dev/null || :
cryptsetup close cryptroot &> /dev/null || :

nvme id-ns -H /dev/"$DISK" | grep -q '1.*4096' && nvme format --lbaf=1 --force /dev/"$DISK"

sgdisk --zap-all /dev/"$DISK"
sgdisk -g /dev/"$DISK"
sgdisk -I -n 1:0:+512M -t 1:ef00 -c 1:bootfs /dev/"$DISK"
sgdisk -I -n 2:0:0 -t 2:8300 -c 2:rootfs /dev/"$DISK"

[[ "$DISK" =~ [0-9]$ ]] && DISK="$DISK"p

mkfs.fat -F 32 /dev/"$DISK"1

echo "$PASS" | cryptsetup -q luksFormat -h sha512 -i 5000 -s 512 /dev/"$DISK"2
echo "$PASS" | cryptsetup open /dev/"$DISK"2 cryptroot

mkfs.btrfs -f /dev/mapper/cryptroot

mount /dev/mapper/cryptroot /mnt
btrfs su cr /mnt/@
btrfs su cr /mnt/@home
btrfs su cr /mnt/@var_log
btrfs su cr /mnt/@var_cache
btrfs su cr /mnt/@var_lib_libvirt_images
chattr +C /mnt/@var_{log,cache,lib_libvirt_images}
umount /mnt

mount -o defaults,compress-force=zstd,noatime,subvol=@ /dev/mapper/cryptroot /mnt
mkdir -p /mnt/{boot,home,var/{log,cache,lib/libvirt/images}}
mount -o defaults,nodev,nosuid,noexec,umask=0077 /dev/"$DISK"1 /mnt/boot
mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,subvol=@home /dev/mapper/cryptroot /mnt/home
mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,noexec,subvol=@var_log /dev/mapper/cryptroot /mnt/var/log
mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,noexec,subvol=@var_cache /dev/mapper/cryptroot /mnt/var/cache
mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,noexec,subvol=@var_lib_libvirt_images /dev/mapper/cryptroot /mnt/var/lib/libvirt/images

reflector -c US -p https -a 12 -l 20 -f 5 --sort rate --save /etc/pacman.d/mirrorlist
sed -i 's/^#\(ParallelDownloads = 5\)/\1/' /etc/pacman.conf

pacstrap /mnt base

genfstab -U /mnt >> /mnt/etc/fstab

useradd -R /mnt -m user
chpasswd -R /mnt <<< root:"$PASS"

echo LANG=en_US.UTF-8 > /mnt/etc/locale.conf
echo en_US.UTF-8 UTF-8 > /mnt/etc/locale.gen

ln -sf /usr/share/zoneinfo/America/New_York /mnt/etc/localtime

cp -r "$DIR" /mnt/home/user/.zenixarch/

arch-chroot /mnt DIR=/home/user/.zenixarch bash -e << CHROOT
$(declare -f configuration)

locale-gen
hwclock --systohc

pacman -S --noconfirm --asdep base-devel
echo "user ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/00_user

sed -i "s|UUID=.*:cryptroot|UUID=$(blkid -s UUID -o value "$(cryptsetup status cryptroot | awk '/device:/ {print $2}')"):cryptroot|" \$DIR/kernel/config
(cp -r \$DIR/kernel /tmp/kbuild && cd /tmp/kbuild
sudo -u user makepkg -si --noconfirm)

pacman -Rcns --noconfirm \$(pacman -Qttdq);
rm -rf /etc/sudoers.d

configuration
CHROOT
