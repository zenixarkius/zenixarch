#!/usr/bin/bash
# shellcheck disable=1091
set -euo pipefail
(( EUID == 0 ))

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

installation() {
  nvme id-ns -H "/dev/${DISK}" | grep -q '1.*4096' && nvme format -l 1 --force "/dev/${DISK}"

  sgdisk -Z "/dev/${DISK}"
  sgdisk -g "/dev/${DISK}"
  sgdisk -I -n 1:0:+512M -t 1:ef00 -c 1:bootfs "/dev/${DISK}"
  sgdisk -I -n 2:0:0 -t 2:8300 -c 2:rootfs "/dev/${DISK}"

  [[ ${DISK} =~ [0-9]$ ]] && DISK="${DISK}p"

  mkfs.fat -F 32 "/dev/${DISK}1"

  cryptsetup -q luksFormat -h sha512 -i 5000 -s 512 "/dev/${DISK}2" <<< "${PASS}"
  cryptsetup open "/dev/${DISK}2" cryptroot <<< "${PASS}"

  mkfs.btrfs -f /dev/mapper/cryptroot

  mount /dev/mapper/cryptroot /mnt
  btrfs su cr /mnt/@
  btrfs su cr /mnt/@home
  btrfs su cr /mnt/@var_log
  btrfs su cr /mnt/@var_cache
  btrfs su cr /mnt/@var_lib_libvirt_images
  chattr +C /mnt/@var_{log,cache,lib_libvirt_images}
  umount /mnt

  mount -o defaults,compress-force=zstd,noatime,subvol=@ /dev/mapper/cryptroot /mnt
  mkdir -p /mnt/{boot,home,var/{log,cache,lib/libvirt/images}}
  mount -o defaults,nodev,nosuid,noexec,umask=0077 "/dev/${DISK}1" /mnt/boot
  mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,subvol=@home /dev/mapper/cryptroot /mnt/home
  mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,noexec,subvol=@var_log /dev/mapper/cryptroot /mnt/var/log
  mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,noexec,subvol=@var_cache /dev/mapper/cryptroot /mnt/var/cache
  mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,noexec,subvol=@var_lib_libvirt_images /dev/mapper/cryptroot /mnt/var/lib/libvirt/images

  pacstrap /mnt base iptables-nft

  genfstab -U /mnt >> /mnt/etc/fstab

  useradd -R /mnt -m user
  chpasswd -R /mnt <<< "root:${PASS}"$'\n'"user:${PASS}"

  cp -r "${DIR}" /mnt/home/user/.zenixarch
  chown user:user -R /mnt/home/user/.zenixarch

  arch-chroot /mnt DIR=/home/user/.zenixarch bash -c 'set -euo pipefail; configuration'
}

configuration() {
  mapfile -t PACKAGES < "${DIR}/lists/packages.list"
  mapfile -t SERVICES < "${DIR}/lists/services.list"

  find "${DIR}"/rootfs -type f | while read -r src; do
    args=(-Dm644) dest=${src#"${DIR}/rootfs"}
    [[ ${src} == */home/user/* ]] && args+=(-o user -g user)
    [[ ${src} == *.link && $(readlink "${dest%.link}") != $(<"${src}") ]] && ln -sfn "$(<"${src}")" "${dest%.link}" && continue
    cmp -s "${src}" "${dest}" || install "${args[@]}" "${src}" "${dest}"
  done

  if ! [[ $(pacman -Q cachyos-keyring cachyos-mirrorlist cachyos-v3-mirrorlist) ]]; then
    pacman-key -a <(curl 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x882dcfe48e2051d48e2562abf3b607488db35a47')
    pacman-key --lsign-key F3B607488DB35A47
    pacman -U --noconfirm https://mirror.cachyos.org/repo/x86_64/cachyos/{cachyos-keyring-20240331-1-any,cachyos-mirrorlist-22-1-any,cachyos-v3-mirrorlist-22-1-any,pacman-7.1.0.r7.gb9f7d4a-3-x86_64}.pkg.tar.zst
  fi

  pacman -Syu --noconfirm --needed "${PACKAGES[@]}"

  for p in "${DIR}"/build/*; do
    if ! [[ $(pacman -Q "$(basename "${p}")") ]]; then (
      cd "${p}"
      . PKGBUILD
      makedepends+=(base-devel)
      pacman -S --noconfirm --needed "${makedepends[@]}"
      mkdir .build
      cp -r ./* .build
      runuser user -c 'makepkg -D .build'
      pacman -U --noconfirm .build/*.pkg.tar.zst
      pacman -Rcns --noconfirm "${makedepends[@]}"
      rm -rf .build
    ) fi
  done

  . "${DIR}/lists/quirks.sh"

  systemctl enable "${SERVICES[@]}"

  for svc in $(systemctl list-unit-files -t service --state=enabled --no-legend | awk '{print $1}'); do
    [[ ${SERVICES[*]} == *${svc}* ]] || [[ ${svc} == getty@* ]] || systemctl disable "${svc}"
  done

  if sbctl status | grep -q 'Setup.*Enabled'; then
    sbctl create-keys
    sbctl enroll-keys -t
    sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI
  fi

  exit
}

[[ -d /run/archiso ]] || configuration

: "${DISK}:?" "${PASS}:?"

read -rp $'You probably shouldn\'t be running this if you aren\'t Zenixark.\nType IK to continue to disk wiping: ' IK
[[ ${IK} == IK ]]

trap 'umount -R /mnt &>/dev/null || :; cryptsetup close cryptroot &>/dev/null || :' EXIT

export -f configuration
installation
