#!/bin/bash
set -euo pipefail

(( EUID == 0 )) || { echo "This script needs to be run as root"; exit 1; }

SCRIPTDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

configuration() {
    find "$SCRIPTDIR"/{bin,etc,home} -type f | while read -r src; do
        if [[ "$src" =~ adguardhome.yaml ]]; then
            cmp -s "$src" /var/lib/private/adguardhome/AdGuardHome.yaml || install -Dm600 -o nobody -g nobody "$src" /var/lib/private/adguardhome/AdGuardHome.yaml
        elif [[ "$src" =~ /bin/ ]]; then
            cmp -s "$src" "/usr/local/${src#"$SCRIPTDIR"/}" || install -Dm755 "$src" "/usr/local/${src#"$SCRIPTDIR"/}"
        else
            cmp -s "$src" "/${src#"$SCRIPTDIR"/}" || install -Dm644 "$src" "/${src#"$SCRIPTDIR"/}"
        fi
    done

    sed -i "s|\${UUID}|$(blkid -s UUID -o value "$(cryptsetup status cryptroot | awk '/device:/ {print $2}')")|" /etc/mkinitcpio.d/cmdline

    pacman -S --noconfirm --needed - < "$SCRIPTDIR"/misc/packages.txt

    "$SCRIPTDIR"/misc/bugfixes.sh

    while read -r svc; do
        systemctl is-enabled -q "$svc" || systemctl enable $NOW "$svc"
    done < "$SCRIPTDIR"/misc/services.txt

    for svc in $(systemctl list-unit-files --type=service --state=enabled --no-legend | awk '{print $1}'); do
        grep -qx "$svc" "$SCRIPTDIR"/misc/services.txt || systemctl disable $NOW "$svc"
    done

    xargs -a "$SCRIPTDIR"/misc/timers.txt systemctl enable
    systemctl mask systemd-boot-random-seed.service

    for d in .cache .local; do
        [[ $(readlink /home/user/$d) =~ /tmp ]] || ln -sfn /tmp /home/user/$d
    done

    chmod 600 /etc/doas.conf
    chown -R user:user /home/user

    mkinitcpio -p linux-zenixark || :

    if sbctl status | grep -q "Setup Mode:.*Enabled"; then
        sbctl create-keys
        sbctl enroll-keys --tpm-eventlog
        sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI
    fi
}

if [[ -d /run/archiso ]]; then
    : "$DISK:?" "$PASS:?"

    echo -e "You probably shouldn't be running this if you aren't Zenixark.\nType 'IK' to continue to disk wiping: "
    read -r CONFIRM
    [[ "$CONFIRM" == "IK" ]] || { echo "You didn't confirm you knew"; exit 1; }

    umount -R /mnt &> /dev/null || :
    cryptsetup close cryptroot &> /dev/null || :

    [[ "$DISK" =~ nvme ]] && { nvme id-ns -H "/dev/$DISK" | grep -q "LBA Format  1.*Data Size: 4096"; } && nvme format --lbaf=1 --force "/dev/$DISK"

    sgdisk --zap-all "/dev/$DISK"
    sgdisk -g "/dev/$DISK"
    sgdisk -I -n 1:0:+512M -t 1:ef00 -c 1:"EFI System" "/dev/$DISK"
    sgdisk -I -n 2:0:0 -t 2:8300 -c 2:"Linux filesystem" "/dev/$DISK"

    [[ "$DISK" =~ [0-9]$ ]] && DISK="${DISK}p"

    mkfs.fat -F 32 "/dev/${DISK}1"

    echo "$PASS" | cryptsetup -q luksFormat -h sha512 -i 5000 -s 512 "/dev/${DISK}2"
    echo "$PASS" | cryptsetup open "/dev/${DISK}2" cryptroot

    mkfs.btrfs -f /dev/mapper/cryptroot

    mount /dev/mapper/cryptroot /mnt
    btrfs su cr /mnt/@
    btrfs su cr /mnt/@home
    btrfs su cr /mnt/@var_log
    btrfs su cr /mnt/@var_cache
    btrfs su cr /mnt/@var_lib_libvirt_images
    chattr +C /mnt/@var_{log,cache,lib_libvirt_images}
    umount /mnt

    mount -o defaults,compress-force=zstd,noatime,subvol=@ /dev/mapper/cryptroot /mnt
    mkdir -p /mnt/{boot,home,var/{log,cache,lib/libvirt/images}}
    mount -o defaults,nodev,nosuid,noexec,umask=0077 "/dev/${DISK}1" /mnt/boot
    mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,subvol=@home /dev/mapper/cryptroot /mnt/home
    mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,noexec,subvol=@var_log /dev/mapper/cryptroot /mnt/var/log
    mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,noexec,subvol=@var_cache /dev/mapper/cryptroot /mnt/var/cache
    mount -o defaults,compress-force=zstd,noatime,nodev,nosuid,noexec,subvol=@var_lib_libvirt_images /dev/mapper/cryptroot /mnt/var/lib/libvirt/images

    reflector -c US -p https -a 12 -l 20 -f 5 --sort rate --save /etc/pacman.d/mirrorlist
    sed -i "s/^#\(ParallelDownloads = 5\)/\1/" /etc/pacman.conf

    curl https://mirror.cachyos.org/cachyos-repo.tar.xz | tar xJvf -
    (cd cachyos-repo && ./cachyos-repo.sh)

    pacstrap /mnt - < "$SCRIPTDIR"/misc/packages.txt

    genfstab -U /mnt >> /mnt/etc/fstab

    echo "LANG=en_US.UTF-8" > /mnt/etc/locale.conf
    echo "en_US.UTF-8 UTF-8" > /mnt/etc/locale.gen

    cp -r "$SCRIPTDIR" /mnt/.zenixarch/

    arch-chroot /mnt bash -e << CHROOT
        $(declare -f configuration)
        export NOW="" SCRIPTDIR=/home/user/.zenixarch

        ln -sf /usr/share/zoneinfo/America/New_York /etc/localtime
        hwclock --systohc

        locale-gen

        useradd -m user
        chpasswd <<< "root:$PASS"$'\n'"user:$PASS"
        passwd -l root

        pacman -S --noconfirm base-devel
        echo "user ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/00_user
        (cd /.zenixarch/zarch/kernel/ && sudo -u user makepkg -si --noconfirm)
        pacman -Rcns --noconfirm base-devel

        mv /boot/vmlinuz-linux-zenixark /usr/lib/modules/vmlinuz
        rm -rf /boot/* /etc/sudoers.d /.zenixarch/zarch/kernel/{src,pkg,*.*}
        mkdir -p /boot/EFI/BOOT
        mv /.zenixarch /home/user

        configuration
CHROOT
else
    NOW="--now"
    configuration
fi

echo "Done"
