# shellcheck shell=bash disable=2034,2154,2164

pkgname=linux-zenixark
_knver=6.19-rc3
_nvver=590.48.01

depends=(iptables-nft mkinitcpio nvidia-utils="${_nvver}" systemd)
makedepends=(bc clang lld llvm perl python)
provides=(NTSYNC-MODULE WIREGUARD-MODULE)

source=(
  config
  linux-zenixark.preset

  https://git.kernel.org/torvalds/t/linux-"${_knver}".tar.gz
  https://us.download.nvidia.com/XFree86/Linux-x86_64/"${_nvver}"/NVIDIA-Linux-x86_64-"${_nvver}".run

  https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${_knver%-*}"/all/0001-cachyos-base-all.patch
  https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${_knver%-*}"/sched/0001-bore-cachy.patch
  https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${_knver%-*}"/misc/nvidia/0001-Enable-atomic-kernel-modesetting-by-default.patch

  https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/intel/ibt-1040-0041.{ddc,sfi}
  https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/intel/iwlwifi/iwlwifi-so-a0-gf-a0{.pnvm,-89.ucode}
  https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files/raw/refs/heads/main/intel-ucode/06-b7-01
)

prepare() {
  sh NVIDIA-Linux-x86_64-${_nvver}.run --extract-only

  mkdir intel{,-ucode}
  mv ibt-1040-0041.{ddc,sfi} intel
  mv 06-b7-01 intel-ucode

  cd linux-${_knver}

  echo -${pkgrel} > localversion.10-pkgrel
  echo ${pkgname#linux} > localversion.20-pkgname

  for src in "${source[@]}"; do
    if [[ ${src} == *nvidia* ]]; then _nvo=(-d "${srcdir}"/NVIDIA-Linux-x86_64-"${_nvver}"/kernel); else _nvo=(); fi
    [[ ${src} == *.patch* ]] && patch -Np1 "${_nvo[@]}" < ../"${src##*/}"
  done

  cp ../config .config
  make LLVM=1 LLVM_IAS=1 olddefconfig

  make -s kernelrelease > version

  diff --color=always ../config .config || read -rp "Press enter to confirm"
}

build() {
  cd linux-${_knver}
  make LLVM=1 LLVM_IAS=1 -j"$(nproc)" all

  cd "${srcdir}"/NVIDIA-Linux-x86_64-${_nvver}/kernel
  make LLVM=1 LLVM_IAS=1 KERNEL_UNAME=${_knver}-${pkgname#linux-} SYSSRC="${srcdir}"/linux-${_knver} SYSOUT="${srcdir}"/linux-${_knver} CC=clang LD=ld.lld NV_EXCLUDE_BUILD_MODULES=__EXCLUDE_MODULES IGNORE_CC_MISMATCH=yes -j"$(nproc)" modules
}

package() {
  cd linux-${_knver}
  modulesdir=${pkgdir}/usr/lib/modules/$(<version)

  install -Dm644 "$(make -s image_name)" "${modulesdir}"/vmlinuz
  install -Dm644 <(echo ${pkgname}) "${modulesdir}"/pkgbase
  install -Dm644 "${srcdir}"/linux-zenixark.preset "${pkgdir}"/etc/mkinitcpio.d/linux-zenixark.preset
  install -Dm644 "${srcdir}"/NVIDIA-Linux-x86_64-${_nvver}/kernel/*.ko "${modulesdir}"

  find "${modulesdir}" -name '*.ko' -print \
    -exec llvm-strip --strip-debug {} \; \
    -exec scripts/sign-file sha512 certs/signing_key.pem certs/signing_key.x509 {} \; \
    -exec zstd --rm -19 -T0 {} +

  ZSTD_CLEVEL=19 make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 INSTALL_MOD_PATH="${pkgdir}"/usr INSTALL_MOD_STRIP=1 DEPMOD=/doesnt/exist modules_install
  rm "${modulesdir}"/build
}

pkgver=${_knver/-/.0_} pkgrel=1 arch=(x86_64) options=(!strip)
sha256sums=('64f0f94ccbbb87bbbba3ba98833076c79c65104405c10171e71ed579678a0001'
            '98cbcef8d813fbfb6be3cf80544d4948c0adba4f5e309c8dc5a04fdb8e288115'
            '4d26f2c2e326444613ffd3dab3ff3c42083e68e5146d34c272086327d264ee1a'
            'b9e2f80693781431cc87f4cd29109e133dcecb50a50d6b68d4b3bf2d696bd689'
            'a76a1484b5bd526fbab8e27e0f18146ed219130ef08baec1572e583c873fe29d'
            'a7339eebb2cf88e531e78a9be7bb90ed0df07d24e9bface267ddc176194bd563'
            '163c57160cc1033020680f638b44ebd94b496152dcd8951e87d5077d4d5c2009'
            'fe272982577efdc289cfe3e8bedafca607c0b7d6c9df1aab1880e22ef930d077'
            '77d231c28ff02c1ef0b5e9d0bd6bb10339da13b59ab023ca3f73df1e5ad827db'
            '96acbcc48f11dacbb04faf5d11319d58b889931656049fca0d59caaa01875386'
            'fb49b19880c5b43ab241cce51e29aacf1a45081e68d7e7e63d9485f3a5d057c1'
            '67c0d6a111a744101ca91912926e08704949098975726a0197232f2a8b21521b')
