# shellcheck shell=bash disable=2034,2154,2164

pkgver=6.18.2
nv=590.48.01

pkgname=linux-zenixark
depends=(mkinitcpio nvidia-utils="${nv}" systemd)
makedepends=(bc clang lld llvm perl python)

source=(config
        linux-zenixark.preset

        https://cdn.kernel.org/pub/linux/kernel/v"${pkgver%%.*}".x/linux-"${pkgver%.0}".tar.xz
        https://us.download.nvidia.com/XFree86/Linux-x86_64/"${nv}"/NVIDIA-Linux-x86_64-"${nv}".run

        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${pkgver%.*}"/all/0001-cachyos-base-all.patch
        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${pkgver%.*}"/sched/0001-bore-cachy.patch
        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${pkgver%.*}"/misc/nvidia/0001-Enable-atomic-kernel-modesetting-by-default.patch

        https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/intel/ibt-1040-0041.ddc
        https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/intel/ibt-1040-0041.sfi
        https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/intel/iwlwifi/iwlwifi-so-a0-gf-a0.pnvm
        https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/intel/iwlwifi/iwlwifi-so-a0-gf-a0-89.ucode

        https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files/raw/refs/heads/main/intel-ucode/06-b7-01)

prepare() {
  sh NVIDIA-Linux-x86_64-${nv}.run --extract-only
  mkdir intel{,-ucode}
  mv ibt-1040-0041.ddc ibt-1040-0041.sfi intel
  mv 06-b7-01 intel-ucode

  cd linux-${pkgver%.0}

  echo -${pkgrel} > localversion.10-pkgrel
  echo ${pkgname#linux} > localversion.20-pkgname

  for src in "${source[@]}"; do
    # shellcheck disable=2046
    [[ ${src} == *.patch* ]] && patch -Np1 $([[ ${src} == *nvidia* ]] && echo "-d ${srcdir}/NVIDIA-Linux-x86_64-${nv}/kernel") < ../"${src##*/}"
  done

  cp ../config .config
  make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 olddefconfig

  make -s kernelrelease > version

  diff --color=always ../config .config || read -rp "Press enter to confirm"
}

build() {
  cd linux-${pkgver%.0}
  make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 -j"$(nproc)" all

  cd "${srcdir}/NVIDIA-Linux-x86_64-${nv}/kernel"
  make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 KERNEL_UNAME=${pkgver}-${pkgname#linux-} SYSSRC="${srcdir}/linux-${pkgver%.0}" SYSOUT="${srcdir}/linux-${pkgver%.0}" NV_EXCLUDE_BUILD_MODULES=__EXCLUDE_MODULES IGNORE_CC_MISMATCH=yes -j"$(nproc)" modules
}

package() {
  cd linux-${pkgver%.0}
  modulesdir=${pkgdir}/usr/lib/modules/$(<version)

  install -Dm644 "$(make -s image_name)" "${modulesdir}/vmlinuz"
  install -Dm644 <(echo ${pkgname}) "${modulesdir}/pkgbase"
  install -Dm644 "${srcdir}/linux-zenixark.preset" "${pkgdir}/etc/mkinitcpio.d/linux-zenixark.preset"

  install -Dm644 "${srcdir}"/NVIDIA-Linux-x86_64-${nv}/kernel/*.ko "${modulesdir}"
  find "${modulesdir}" -name '*.ko' -print -exec llvm-strip --strip-debug {} \; -exec scripts/sign-file sha512 certs/signing_key.pem certs/signing_key.x509 {} \; -exec zstd --rm -19 -T0 {} +

  ZSTD_CLEVEL=19 make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 INSTALL_MOD_PATH="${pkgdir}"/usr INSTALL_MOD_STRIP=1 DEPMOD=/doesnt/exist modules_install
  rm "${modulesdir}"/build
}

arch=(x86_64) options=(!strip) pkgrel=1
sha256sums=('9409ae207a90367db1ddb74442263bba9b41ba834f039d3683005a21829e98d5'
            '194366374332777238546afe17de33af7445c539dc5a39ba32f62e9c2b7d17e2'
            '558c6bbab749492b34f99827fe807b0039a744693c21d3a7e03b3a48edaab96a'
            'b9e2f80693781431cc87f4cd29109e133dcecb50a50d6b68d4b3bf2d696bd689'
            '50f8ee57dac77223f0c1290cccde95f1a797c6c530eb5b43d8fd3c51755e29d5'
            'f88d72d2cc374ee03e8200055459d5e4fbeb3fd14cbd197a95766839d536b483'
            '163c57160cc1033020680f638b44ebd94b496152dcd8951e87d5077d4d5c2009'
            'fe272982577efdc289cfe3e8bedafca607c0b7d6c9df1aab1880e22ef930d077'
            '77d231c28ff02c1ef0b5e9d0bd6bb10339da13b59ab023ca3f73df1e5ad827db'
            '96acbcc48f11dacbb04faf5d11319d58b889931656049fca0d59caaa01875386'
            'fb49b19880c5b43ab241cce51e29aacf1a45081e68d7e7e63d9485f3a5d057c1'
            '67c0d6a111a744101ca91912926e08704949098975726a0197232f2a8b21521b')
