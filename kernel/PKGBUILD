# shellcheck shell=bash disable=2034,2154,2164

pkgver=6.18.1
nv=580.119.02

pkgname=linux-zenixark
depends=(mkinitcpio nvidia-utils="${nv}" systemd)
makedepends=(bc clang lld llvm perl python tar)

source=(config
        linux-zenixark.preset

        https://cdn.kernel.org/pub/linux/kernel/v"${pkgver%%.*}".x/linux-"${pkgver%.0}".tar.xz
        https://us.download.nvidia.com/XFree86/Linux-x86_64/"${nv}"/NVIDIA-Linux-x86_64-"${nv}".run

        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${pkgver%.*}"/all/0001-cachyos-base-all.patch
        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${pkgver%.*}"/sched/0001-bore-cachy.patch
        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${pkgver%.*}"/misc/nvidia/0001-Enable-atomic-kernel-modesetting-by-default.patch

        git+https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files.git
        git+https://gitlab.com/kernel-firmware/linux-firmware.git)

prepare() {
  sh NVIDIA-Linux-x86_64-${nv}.run --extract-only
  mv linux-firmware/intel/iwlwifi/* Intel-Linux-Processor-Microcode-Data-Files/intel-ucode linux-firmware

  cd linux-${pkgver%.0}

  echo -${pkgrel} > localversion.10-pkgrel
  echo ${pkgname#linux} > localversion.20-pkgname

  for src in "${source[@]}"; do
    # shellcheck disable=2046
    [[ ${src} == *.patch* ]] && patch -Np1 $([[ ${src} == *nvidia* ]] && echo "-d ${srcdir}/NVIDIA-Linux-x86_64-${nv}/kernel") < ../"${src##*/}"
  done

  cp ../config .config
  make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 olddefconfig
  diff --color=always ../config .config || read -rp "Press enter to confirm"

  make -s kernelrelease > version
}

build() {
  cd linux-${pkgver%.0}
  make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 -j"$(nproc)" all

  cd "${srcdir}/NVIDIA-Linux-x86_64-${nv}/kernel"
  make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 KERNEL_UNAME=${pkgver}-${pkgname#linux-} SYSSRC="${srcdir}/linux-${pkgver%.0}" SYSOUT="${srcdir}/linux-${pkgver%.0}" NV_EXCLUDE_BUILD_MODULES=__EXCLUDE_MODULES IGNORE_CC_MISMATCH=yes -j"$(nproc)" modules
}

package() {
  cd linux-${pkgver%.0}
  modulesdir=${pkgdir}/usr/lib/modules/$(<version)

  install -Dm644 "$(make -s image_name)" "${modulesdir}/vmlinuz"
  install -Dm644 <(echo ${pkgname}) "${modulesdir}/pkgbase"
  install -Dm644 "${srcdir}/linux-zenixark.preset" "${pkgdir}/etc/mkinitcpio.d/linux-zenixark.preset"

  install -Dm644 "${srcdir}"/NVIDIA-Linux-x86_64-${nv}/kernel/*.ko "${modulesdir}"
  find "${modulesdir}" -name '*.ko' -print -exec llvm-strip --strip-debug {} \; -exec scripts/sign-file sha512 certs/signing_key.pem certs/signing_key.x509 {} \; -exec zstd --rm -19 -T0 {} +

  ZSTD_CLEVEL=19 make CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 INSTALL_MOD_PATH="${pkgdir}"/usr INSTALL_MOD_STRIP=1 DEPMOD=/doesnt/exist modules_install
  rm "${modulesdir}"/build
}

arch=(x86_64) options=(!strip) pkgrel=1
sha256sums=('ed99acbfd0f3024b225194a093350ec699fb613606bf4a138bd375902a7b61f6'
            '9b8909ffbc8918408dbc2ac9cf234422c2c484c23ba6c46ee1b10e8f501f1ae7'
            'd0a78bf3f0d12aaa10af3b5adcaed5bc767b5b78705e5ef885d5e930b72e25d5'
            '8020f5dfd3ee88aee7a38990d0c3d2afe54751e9a170ba9eadd7ea670138ecd7'
            'fb945473f46e1c873ee8223cd2c62a4bdc19b70323a04229e4a600574cdcee27'
            'f88d72d2cc374ee03e8200055459d5e4fbeb3fd14cbd197a95766839d536b483'
            '163c57160cc1033020680f638b44ebd94b496152dcd8951e87d5077d4d5c2009'
            'SKIP'
            'SKIP')
