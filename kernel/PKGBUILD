pkgrel=1
pkgver=6.17.8
nv_ver=580.105.08
_srcname=linux-$pkgver
pkgname=linux-zenixark
pkgbase=$pkgname
pkgdesc="Zenixark's attempt at a custom kernel + NVIDIA drivers v$nv_ver"
url=https://zenixark.com/zenixark/zenixarch
arch=(x86_64)
makedepends=(bc clang cpio lld llvm pahole perl python)

source=(https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/$_srcname.tar.xz
        https://us.download.nvidia.com/XFree86/Linux-x86_64/$nv_ver/NVIDIA-Linux-x86_64-$nv_ver.run
        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/${pkgver%.*}/all/0001-cachyos-base-all.patch
        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/${pkgver%.*}/sched/0001-bore-cachy.patch
        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/${pkgver%.*}/misc/nvidia/0001-Enable-atomic-kernel-modesetting-by-default.patch
        config)

sha256sums=('5a8de64a75fca706c01c6c0a77cf75a74618439db195e25f1f0268af6b2fb1da'
            'd9c6e8188672f3eb74dd04cfa69dd58479fa1d0162c8c28c8d17625763293475'
            'fd0951f22f117263c39a410a646194685aacb4a073da7759de9406f88c396adf'
            'b7f52515927d1938f88b593141c4db65cf0827dfa3b4f2cf9f7bef493aa786c9'
            '163c57160cc1033020680f638b44ebd94b496152dcd8951e87d5077d4d5c2009'
            'SKIP')

FLAGS=(CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1)
export MAKEFLAGS="-j$(nproc)"
export KBUILD_BUILD_HOST=zenixark
export KBUILD_BUILD_USER=$pkgbase
export KBUILD_BUILD_TIMESTAMP="$(date -Ru${SOURCE_DATE_EPOCH:+d @$SOURCE_DATE_EPOCH})"

prepare() {
    cd $_srcname

    echo "Setting version..."
    echo "-$pkgrel" > localversion.10-pkgrel
    echo "${pkgbase#linux}" > localversion.20-pkgname

    local src
    for src in "${source[@]}"; do
        [[ $src = *nvidia* ]] && continue
        src="${src%%::*}"
        src="${src##*/}"
        src="${src%.zst}"
        [[ $src = *.patch ]] || continue
        echo "Applying patch $src..."
        patch -Np1 < "../$src"
    done

    echo "Setting config..."
    cp ../config .config
    make "${FLAGS[@]}" olddefconfig
    diff --color=always ../config .config

    make -s kernelrelease > version
    echo "Prepared $pkgbase version $(<version)"

    echo "Unpacking NVIDIA drivers..."
    cd $srcdir
    sh NVIDIA-Linux-x86_64-$nv_ver.run --extract-only
    patch -Np1 -i $srcdir/0001-Enable-atomic-kernel-modesetting-by-default.patch -d NVIDIA-Linux-x86_64-$nv_ver/kernel
}

build() {
    cd $_srcname
    make "${FLAGS[@]}" all

    cd $srcdir/NVIDIA-Linux-x86_64-$nv_ver/kernel
    make "${FLAGS[@]}" KERNEL_UNAME=$pkgver-${pkgbase#linux-} SYSSRC=$srcdir/$_srcname SYSOUT=$srcdir/$_srcname NV_EXCLUDE_BUILD_MODULES=__EXCLUDE_MODULES modules
}

package() {
    depends=(coreutils kmod initramfs nvidia-utils=$nv_ver libglvnd)
    provides=(NTSYNC-MODULE NVIDIA-MODULE WIREGUARD-MODULE)

    cd $_srcname
    local modulesdir="$pkgdir/usr/lib/modules/$(<version)"

    echo "Installing boot image..."
    install -Dm644 "$(make -s image_name)" "$modulesdir/vmlinuz"
    echo "$pkgbase" | install -Dm644 /dev/stdin "$modulesdir/pkgbase"

    echo "Installing NVIDIA drivers..."
    (cd $srcdir/NVIDIA-Linux-x86_64-$nv_ver
    install -dm755 $modulesdir
    install -m644 kernel/*.ko $modulesdir
    install -Dt $pkgdir/usr/share/licenses/$pkgname -m644 LICENSE)
    find $modulesdir -type f -name '*.ko' -print -exec scripts/sign-file sha512 certs/signing_key.pem certs/signing_key.x509 {} \;
    find $pkgdir -name '*.ko' -exec zstd --rm -19 -T0 {} +

    echo "Installing modules..."
    ZSTD_CLEVEL=19 make "${BUILD_FLAGS[@]}" INSTALL_MOD_PATH="$pkgdir/usr" INSTALL_MOD_STRIP=1 DEPMOD=/doesnt/exist  modules_install
    rm $modulesdir/build
}
