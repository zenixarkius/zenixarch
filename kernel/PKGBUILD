# shellcheck shell=bash disable=2034,2154,2164

pkgver=6.18.4
_nvver=590.48.01

pkgname=linux-zenixark
depends=(mkinitcpio nvidia-utils="${_nvver}")
makedepends=(bc clang lld llvm perl python)
provides=(NTSYNC-MODULE NVIDIA-MODULE WIREGUARD-MODULE)

source=(config
        linux-zenixark.preset

        https://cdn.kernel.org/pub/linux/kernel/v"${pkgver%%.*}".x/linux-"${pkgver%.0}".tar.xz
        https://us.download.nvidia.com/XFree86/Linux-x86_64/"${_nvver}"/NVIDIA-Linux-x86_64-"${_nvver}".run

        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${pkgver%.*}"/all/0001-cachyos-base-all.patch
        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${pkgver%.*}"/sched/0001-bore-cachy.patch
        https://raw.githubusercontent.com/CachyOS/kernel-patches/refs/heads/master/"${pkgver%.*}"/misc/nvidia/0001-Enable-atomic-kernel-modesetting-by-default.patch

        https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/intel/ibt-1040-0041.{ddc,sfi}
        https://gitlab.com/kernel-firmware/linux-firmware/-/raw/main/intel/iwlwifi/iwlwifi-so-a0-gf-a0{.pnvm,-89.ucode}
        https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files/raw/refs/heads/main/intel-ucode/06-b7-01)

prepare() {
  sh NVIDIA-Linux-x86_64-${_nvver}.run --extract-only

  mkdir intel{,-ucode}
  mv ibt-1040-0041.{ddc,sfi} intel
  mv 06-b7-01 intel-ucode

  cd linux-${pkgver%.0} 

  for src in "${source[@]}"; do
    if [[ ${src} == *nvidia* ]]; then _nvo=(-d "${srcdir}"/NVIDIA-Linux-x86_64-"${_nvver}"/kernel); else _nvo=(); fi
    [[ ${src} == *.patch* ]] && patch -Np1 "${_nvo[@]}" < ../"${src##*/}"
  done

  cp ../config .config
  make LLVM=1 olddefconfig

  echo -${pkgrel} > localversion.10-pkgrel
  echo ${pkgname#linux} > localversion.20-pkgname
  make -s kernelrelease > version

  diff --color=always ../config .config || read -rp "Press enter to confirm"
}

build() {
  cd linux-${pkgver%.0}
  make LLVM=1 -j"$(nproc)" all

  cd "${srcdir}"/NVIDIA-Linux-x86_64-${_nvver}/kernel
  make CC=clang LD=ld.lld KERNEL_UNAME=${pkgver}-${pkgname#linux-} {SYSSRC,SYSOUT}="${srcdir}"/linux-${pkgver%.0} NV_EXCLUDE_BUILD_MODULES=__EXCLUDE_MODULES IGNORE_CC_MISMATCH=yes -j"$(nproc)" modules
}

package() {
  cd linux-${pkgver}
  modulesdir=${pkgdir}/usr/lib/modules/$(<version)

  install -Dm644 "$(make -s image_name)" "${modulesdir}"/vmlinuz
  install -Dm644 <(echo ${pkgname}) "${modulesdir}"/pkgbase
  install -Dm644 "${srcdir}"/linux-zenixark.preset "${pkgdir}"/etc/mkinitcpio.d/linux-zenixark.preset
  install -Dm644 "${srcdir}"/NVIDIA-Linux-x86_64-${_nvver}/kernel/*.ko "${modulesdir}"

  find "${modulesdir}" -name '*.ko' -print \
    -exec llvm-strip --strip-debug {} \; \
    -exec scripts/sign-file sha512 certs/signing_key.pem certs/signing_key.x509 {} \; \
    -exec zstd --rm -19 -T0 {} +

  make INSTALL_MOD_PATH="${pkgdir}"/usr DEPMOD=/doesnt/exist modules_install
  rm "${modulesdir}"/build
}

pkgrel=1 arch=(x86_64) options=(!strip)
sha256sums=('04dc0a83849bd8ec1f3ac67523009ff76ac807c5689317be1565db559bac7e1f'
            '05d100b297182b5e61fe37d07781e8766416f78524ed7f7382f4d0796bc14023'
            'f850139ca5f79c1bf6bb8b32f92e212aadca97bdaef8a83a7cf4ac4d6a525fab'
            'b9e2f80693781431cc87f4cd29109e133dcecb50a50d6b68d4b3bf2d696bd689'
            '62d8574a970ee6fe5ca5d758eb1031502890cdf9be4c44733ba9ba292eb05542'
            'f88d72d2cc374ee03e8200055459d5e4fbeb3fd14cbd197a95766839d536b483'
            '163c57160cc1033020680f638b44ebd94b496152dcd8951e87d5077d4d5c2009'
            'fe272982577efdc289cfe3e8bedafca607c0b7d6c9df1aab1880e22ef930d077'
            '77d231c28ff02c1ef0b5e9d0bd6bb10339da13b59ab023ca3f73df1e5ad827db'
            '96acbcc48f11dacbb04faf5d11319d58b889931656049fca0d59caaa01875386'
            'fb49b19880c5b43ab241cce51e29aacf1a45081e68d7e7e63d9485f3a5d057c1'
            '67c0d6a111a744101ca91912926e08704949098975726a0197232f2a8b21521b')
